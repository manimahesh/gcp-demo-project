name: Build and Push

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      REGION: us-central1
    outputs:
      image: ${{ steps.set-image.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP (OIDC)
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          install_components: gke-gcloud-auth-plugin, docker-credential-gcr

      - name: Configure Docker
        run: |
          gcloud auth configure-docker
          gcloud --quiet auth configure-docker ${REGION}-docker.pkg.dev
        env:
          REGION: us-central1

      - name: Build Docker image
        run: |
          docker build -t ${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/vuln-demo-repo/backend:latest backend/
        env:
          REGION: us-central1

      - name: Push Docker image
        run: |
          docker push ${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/vuln-demo-repo/backend:latest
        env:
          REGION: us-central1

      - name: Set image output
        id: set-image
        run: |
          echo "image=${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/vuln-demo-repo/backend:latest" >> $GITHUB_OUTPUT
        env:
          REGION: us-central1

      - name: Setup gcloud and kubectl
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          install_components: gke-gcloud-auth-plugin, kubectl

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER_NAME }} --region ${REGION} --project ${{ secrets.GCP_PROJECT }}
        env:
          REGION: us-central1

      - name: Deploy backend image to GKE (kubectl set image)
        run: |
          set -euo pipefail
          echo "Installing gke auth plugin"
          gcloud components install gke-gcloud-auth-plugin || true

          # Determine image to deploy
          IMAGE="${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/vuln-demo-repo/backend:latest"
          echo "Raw image from build job output: '${IMAGE}'"
          if [ -z "${IMAGE}" ]; then
            IMAGE="${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/vuln-demo-repo/backend:latest"
            echo "Build output was empty. Falling back to computed image: ${IMAGE}"
          fi
          if [ -z "${IMAGE}" ]; then
            echo "ERROR: image is empty â€” aborting deploy. Ensure 'GCP_PROJECT' secret is set and build job succeeded." >&2
            exit 1
          fi

          echo "Setting deployment image to: ${IMAGE}"
          kubectl set image deployment/vuln-backend vuln-backend=${IMAGE} --record
          echo "Waiting for rollout to complete"
          kubectl rollout status deployment/vuln-backend --timeout=120s || (kubectl describe deployment vuln-backend && kubectl get pods -o wide && exit 1)
          echo "Deployment applied. Showing deployment summary:"
          kubectl get deploy vuln-backend -o wide
 
