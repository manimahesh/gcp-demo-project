name: Build and Push

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      REGION: us-central1
      CORTEX_API_KEY: ${{secrets.CORTEX_API_KEY}}
      CORTEX_API_KEY_ID: ${{secrets.CORTEX_API_KEY_ID}}
      CORTEX_API_URL: https://api-ms-ccr.xdr.us.paloaltonetworks.com
    outputs:
      image: ${{ steps.set-image.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP (OIDC)
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          install_components: gke-gcloud-auth-plugin, docker-credential-gcr

      - name: Configure Docker
        run: |
          gcloud auth configure-docker
          gcloud --quiet auth configure-docker ${REGION}-docker.pkg.dev
        env:
          REGION: us-central1

      - name: Build Docker image
        run: |
          # Build from app directory where Dockerfile and all application files are located
          docker build -t ${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/vuln-demo-repo/backend:latest app/
        env:
          REGION: us-central1

      - name: Push Docker image
        run: |
          docker push ${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/vuln-demo-repo/backend:latest
        env:
          REGION: us-central1

      - name: Set image output
        id: set-image
        run: |
          echo "image=${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/vuln-demo-repo/backend:latest" >> $GITHUB_OUTPUT
        env:
          REGION: us-central1

      - name: Setup gcloud and kubectl
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          install_components: gke-gcloud-auth-plugin, kubectl

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER_NAME }} --region ${REGION} --project ${{ secrets.GCP_PROJECT }}
        env:
          REGION: us-central1

      - name: Deploy backend using manifest
        run: |
          set -euo pipefail
          echo "Installing gke auth plugin"
          gcloud components install gke-gcloud-auth-plugin || true

          # Prefer the image from the set-image step; fall back to computed name
          IMAGE="${{ steps.set-image.outputs.image }}"
          echo "Image from build step: '${IMAGE}'"
          if [ -z "${IMAGE}" ]; then
            IMAGE="${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/vuln-demo-repo/backend:latest"
            echo "Build output was empty. Falling back to computed image: ${IMAGE}"
          fi
          if [ -z "${IMAGE}" ]; then
            echo "ERROR: image is empty â€” aborting deploy. Ensure 'GCP_PROJECT' secret is set and build job succeeded." >&2
            exit 1
          fi

          echo "Original manifest (first 100 lines):"
          sed -n '1,100p' k8s/backend-deployment.yaml || true

          echo "Patching k8s/backend-deployment.yaml with image $IMAGE"
          sed -i "s|REPLACE_WITH_IMAGE_OR_ARTIFACT_REGISTRY_PATH|$IMAGE|g" k8s/backend-deployment.yaml

          echo "Patched manifest (first 100 lines):"
          sed -n '1,200p' k8s/backend-deployment.yaml || true

          echo "Applying manifest"
          kubectl apply -f k8s/backend-deployment.yaml
          echo "Waiting for rollout to complete"
          kubectl rollout status deployment/vuln-backend --timeout=120s || (kubectl describe deployment vuln-backend && kubectl get pods -o wide && exit 1)
          echo "Deployment applied. Showing deployment summary:"
          kubectl get deploy vuln-backend -o wide
 
      - name: Print External IP for Service
        run: |
          echo "Waiting for LoadBalancer external IP for vuln-backend-svc..."
          chmod +x scripts/print_external_ip.sh
          ./scripts/print_external_ip.sh || true
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Verify Node.js Version
        run: node -v

      - name: Download cortexcli
        run: |
          set -x
          crtx_resp=$(curl "${CORTEX_API_URL}/public_api/v1/unified-cli/releases/download-link?os=linux&architecture=amd64" \
            -H "x-xdr-auth-id: ${CORTEX_API_KEY_ID}" \
            -H "Authorization: ${CORTEX_API_KEY}")
          crtx_url=$(echo $crtx_resp | jq -r ".signed_url")
          curl -o cortexcli $crtx_url
          chmod +x cortexcli
          ./cortexcli --version

      - name: Run Cortex CLI Code Scan
        run: |
          ./cortexcli \
            --api-base-url "${CORTEX_API_URL}" \
            --api-key "${CORTEX_API_KEY}" \
            --api-key-id "${CORTEX_API_KEY_ID}" \
            code scan \
            --directory "${{github.workspace}}" \
            --repo-id "${{github.repository}}" \
            --branch "${{github.ref_name}}" \
            --source "GITHUB_ACTIONS" \
            --create-repo-if-missing

