name: Build and Push

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      REGION: us-central1
    outputs:
      image: ${{ steps.set-image.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP (OIDC)
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          install_kubectl: false

      - name: Configure Docker
        run: |
          gcloud auth configure-docker
          gcloud --quiet auth configure-docker ${REGION}-docker.pkg.dev
        env:
          REGION: us-central1

      - name: Build Docker image
        run: |
          docker build -t ${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/vuln-demo-repo/backend:latest backend/
        env:
          REGION: us-central1

      - name: Push Docker image
        run: |
          docker push ${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/vuln-demo-repo/backend:latest
        env:
          REGION: us-central1

      - name: Run Trivy scan (optional)
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image --severity HIGH,CRITICAL ${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/vuln-demo-repo/backend:latest
        env:
          REGION: us-central1

      - name: Set image output
        id: set-image
        run: |
          echo "image=${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/vuln-demo-repo/backend:latest" >> $GITHUB_OUTPUT
        env:
          REGION: us-central1

  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build-and-push
    env:
      REGION: us-central1
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP (OIDC)
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Setup gcloud and kubectl
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          install_components: gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER_NAME }} --region ${REGION} --project ${{ secrets.GCP_PROJECT }}
        env:
          REGION: us-central1

      - name: Patch k8s manifest with built image
        run: |
          # Prefer the image set by the build job output, but fall back to a computed image
          IMAGE="${{ needs.build-and-push.outputs.image }}"
          echo "Raw image from build job output: '$IMAGE'"
          if [ -z "$IMAGE" ]; then
            # Fallback: compute the expected image name using REGION and project secret
            IMAGE="${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/vuln-demo-repo/backend:latest"
            echo "Build output was empty. Falling back to computed image: $IMAGE"
          fi
          if [ -z "$IMAGE" ]; then
            echo "ERROR: computed image is empty â€” aborting deploy. Ensure 'GCP_PROJECT' secret is set and build job succeeded." >&2
            exit 1
          fi
          echo "Original manifest (first 100 lines):"
          sed -n '1,100p' k8s/backend-deployment.yaml || true
          echo "Patching k8s/backend-deployment.yaml with image $IMAGE"
          sed -i "s|REPLACE_WITH_IMAGE_OR_ARTIFACT_REGISTRY_PATH|$IMAGE|g" k8s/backend-deployment.yaml
          echo "Patched manifest (first 100 lines):"
          sed -n '1,100p' k8s/backend-deployment.yaml || true

      - name: Deploy backend image to GKE
        run: |
          gcloud components install gke-gcloud-auth-plugin
          kubectl apply -f k8s/backend-deployment.yaml
        env:
          REGION: us-central1
 
